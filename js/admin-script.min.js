(function($) {
    "use strict";

    let creationTimer;
    let elapsed = 0;
    const duration = 120; // 2 minutes

    function show_loading() {
        if ($("#app-creation-overlay").length === 0) {
            $("body").append(
                "<div id='app-creation-overlay' style='display:none;'>" +
                "<div class='loader-box'>" +
                "<h2>Your app is being created...</h2>" +
                "<p id='status-msg'>Estimated time about 2 minutes</p>" +
                "<div class='progress-bar'><div id='progress-fill'></div></div>" +
                "<p id='countdown'></p>" +
                "</div></div>"
            );
        }

        const overlay = $("#app-creation-overlay");
        overlay.show().removeClass("hidden");

        elapsed = 0;
        const countdownEl = $("#countdown");
        const progressEl = $("#progress-fill");

        creationTimer = setInterval(() => {
            elapsed++;
            const remaining = duration - elapsed;
            const percent = Math.min((elapsed / duration) * 100, 100);
            progressEl.css("width", percent + "%");

            if (elapsed >= duration - 10 && elapsed < duration) {
                countdownEl.text("Giving final touches to your app...");
            }

            if (elapsed >= duration) {
                hide_loading();
            }
        }, 1000);
    }

    function hide_loading() {
        clearInterval(creationTimer);
        const overlay = $("#app-creation-overlay");
        $("#progress-fill").css("width", "100%");
        $("#countdown").text("Completed!");
        $("#status-msg").text("Your app is ready ðŸŽ‰");

        setTimeout(() => {
            overlay.addClass("hidden");
            setTimeout(() => overlay.hide(), 500);
        }, 2000);
    }

    function show_loading_generic(message) {
        if ($(".loaderBox").length === 0) {
            $("body").append(
                "<div class='loaderBox'>" +
                "<div class='loaderIn'>" +
                "<h1 class='loaderInfo'>" + message + "</h1>" +
                "<div class='loaderBoxIn'><div class='contentBar'>" +
                "<div id='block_1' class='barlittle'></div>" +
                "<div id='block_2' class='barlittle'></div>" +
                "<div id='block_3' class='barlittle'></div>" +
                "<div id='block_4' class='barlittle'></div>" +
                "<div id='block_5' class='barlittle'></div>" +
                "</div></div></div></div>"
            );
        }
        $(".loaderBox").show();
    }

    function hide_loading_generic() {
        $(".loaderBox").hide();
    }

    function track_execution() {
        setTimeout(() => {
            $("#errorResponse").html(
                "It appears that your app compilation is taking a bit longer than normal. " +
                "Please try again, or contact us if the issue persists."
            );
        }, 300000); // 5 minutes
    }

    function custom_page(pid) {
		 $("#wapppress_field_markup_text, #wapppress_home_setting").val(pid);
        $(".panel").hide();
    }


    function ajax_wapp_push_form() {

        // ### EXTERNAL SERVICE NOTICE
        // This plugin connects to our push notification service hosted at:
        //   http://199.38.85.107/aapi/api-push-msg-v.0.4-t.php
        // Data sent: push message content, security nonce
        // Purpose: To deliver push notifications to Android apps created by WappPress
        // Terms: Provided by WappPress, see privacy policy at http://wapppress.com/privacy

        const ajaxData = new FormData($("#push_from")[0]);
        const ip = 'http://199.38.85.107/aapi';
        const ap = '/';
        const pluginUrl = $('#dirPlgUrl1').val();

        ajaxData.append('action', 'create_push_app');
        ajaxData.append('type', 'push_form');
        ajaxData.append('ip', ip);
        ajaxData.append('ap', ap);
        ajaxData.append('file', 'api-push-msg-v.0.4-t.php');
        ajaxData.append('security', wapppressPluginData.nonce);

        $.ajax({
            type: "POST",
            url: ajaxurl,
            data: ajaxData,
            cache: false,
            dataType: "json",
            contentType: false,
            processData: false,
            beforeSend: () => show_loading_generic("Please wait while the system sends your notification password"),
            complete: () => hide_loading_generic(),
            success: function(response) {
                if (response && response.data) {
                    const res = $.trim(response.data);
                    let msg = 'Error occurred to send push notification. Please try again';
                    if (res == '1') msg = "Your push notification / alert message has been sent successfully.";
                    $("#msgId").html(msg);
                    $('textarea[name="push_msg"]').val("");
                    //setTimeout(() => $("#msgId").fadeOut("slow"), 3000);
                }
				$("#push_area").hide();
            },
            error: () => {
                $("#msgId").html('Error occurred to send push notification. Please try again');
                $('textarea[name="push_msg"]').val("");
               // setTimeout(() => $("#msgId").fadeOut("slow"), 3000);
				$("#push_area").hide();
				
            }
        });
    }

    function ajax_wapp_api_form() {

        // ### EXTERNAL SERVICE NOTICE
        // This plugin connects to our app compilation service hosted at:
        //   https://author.wapppress.com/dwd/dwn25.php
        // Data sent: app configuration, security nonce
        // Purpose: To compile Android apps for the WordPress site
        // Terms: Provided by WappPress, see privacy policy at http://wapppress.com/privacy
        // QR code service: https://qrcode.tec-it.com/ API is used to generate QR codes for app download
        // Data sent to QR service: app download URL

        const app_type = $('input[name="app_type"]:checked').val();
        const ajaxData = new FormData($("#customer_support")[0]);
        const ip = 'http://199.38.85.107/app-api';
        const ap = '/';
        const pluginUrl = $('#dirPlgUrl1').val();
		const wapppress_lic = $('#license').val().trim();

        ajaxData.append('action', 'create_app');
        ajaxData.append('type', 'api_create_form');
        ajaxData.append('ip', ip);
        ajaxData.append('ap', ap);
        ajaxData.append('security', wapppressPluginData.nonce);
		
			let file = '';
			let extn = '';

			if (wapppress_lic !== '') {

				// PRO
				file = 'api-pro-25.4-pro.php';
				extn = '.apk';

				if (app_type == 1) {
					file = 'api-pro-25.5-pro.php';
					extn = '.aab';
				}

			} else {

				// TRIAL / BASIC
				file = 'api-pro-25.4-t.php';
				extn = '.apk';

				if (app_type == 1) {
					file = 'api-pro-25.5-t.php';
					extn = '.aab';
				}
			}

		
		let cleanExt = extn.replace(/^\./, ''); 
        ajaxData.append('file', file);
        ajaxData.append('dwn_type', cleanExt);

        $.ajax({
            type: "POST",
            url: ajaxurl,
            data: ajaxData,
            cache: false,
            dataType: "json",
            contentType: false,
            processData: false,
            beforeSend: show_loading,
            success: function(response) {
                if (response && response.data) {
                    hide_loading();
                    const val = response.data.split('~');
                    const apn = `https://author.wapppress.com/app/?app=${val[1]}&type=${cleanExt}`;
                    const apn_symbols = `https://author.wapppress.com/dwd/dwn25.php?appfile=symbols-${val[1]}.zip`;
					const dw_url = `https://author.wapppress.com/app/download.php?app=${encodeURIComponent(val[1])}&type=${encodeURIComponent(cleanExt)}`;
	
					$("#dwnloakIdLink").css('display','block').html(`<a href="${dw_url}"   class="btn btn-info-dwd  btn-lg submit-build"   role="button"> Download Your App</a>`);
                    $("#dwnloakId").css('display','block').html(
                        `<strong>Scan to Download your App:</strong><br/>
                           <img src="https://qrcode.tec-it.com/API/QRCode?data=${encodeURIComponent(apn)}&backcolor=%23ffffff&size=small&quietzone=1&errorcorrection=H" 
                           alt="QR Code" style="height:150px"/><br/>Scan this QR code with your smartphone to download the app directory.`
						   
                    );
					if(app_type==2)
					{
						$("#app_help_apk").css('display','block');
						$("#app_help_aab").css('display','none');
					}else{
						$("#app_help_aab").css('display','block');
						$("#app_help_apk").css('display','none');
					}
                }
            },
            error: function(xhr) {
                console.error(xhr.status, xhr.statusText);
            }
        });
    }

    // --- Document ready code remains the same ---
    $(document).ready(function() {
        // iframe preview setup, home setting search, switches, theme changes...
    });

    function setCookie(cname, cvalue, expdays) {
        const d = new Date();
        d.setTime(d.getTime() + (expdays * 24 * 60 * 60 * 1000));
        document.cookie = `${cname}=${cvalue}; expires=${d.toUTCString()}`;
    }

    function show_popup(id) { $('#' + id).show(); }
    function close_popup(id) { $('#' + id).hide(); }

    // Expose functions globally
    window.show_loading = show_loading;
    window.hide_loading = hide_loading;
    window.show_loading_generic = show_loading_generic;
    window.hide_loading_generic = hide_loading_generic;
    window.ajax_wapp_push_form = ajax_wapp_push_form;
    window.ajax_wapp_api_form = ajax_wapp_api_form;
    window.track_execution = track_execution;
    window.custom_page = custom_page;

      if (typeof wapppressAjax === 'undefined') {
        console.error('wapppressAjax not defined');
        return;
    }

    $.ajax({
        url: wapppressAjax.ajaxurl,
        type: 'POST',
        data: {
            action: 'wapppress_check_trial',
            nonce: wapppressAjax.nonce
        },
        success: function (res) {
            console.log('AJAX OK', res);
        },
        error: function (xhr) {
            console.error('AJAX ERROR', xhr.responseText);
        }
    });


})(jQuery);
jQuery(document).ready(function(e){var t=e("#wapppress_url").val();e("#wapppress_home_setting").on("keyup",function(t){var n=e("#wapppress_home_setting").val();if(n.length<2){e(".wapppress_field_markup_text").css({display:"none"});return}else{e(".wapppress_field_markup_text").css({display:"block"})}if(t.which<=90&&t.which>=48||t.which==8){var r={action:"search_post_handler",search_val:n,nonce:e("#_wpnonce").val()};e.ajax({type:"POST",dataType:"json",url:ajaxurl,data:r,success:function(t){if(typeof t.data!=="undefined"){e(".wapppress_field_markup_text").html(t.data)}}})}});e(".wapppress_field_markup_text a").on("click",function(t){var n=e(this);console.log("this data",n);e("#wapppress_home_setting").val(n.data("postid"));e("#wapppress_field_markup_text").hide();return false});});